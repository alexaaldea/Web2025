<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Generated Inputs History</title>
  <link rel="stylesheet" href="../../css/history.css">
</head>
<body>
  <h1>Your Generated Inputs</h1>

  <div id="history-container"></div>

  <script>
    function createTable(sectionTitle, data) {
      const section = document.createElement('div');
      section.className = 'section';

      const title = document.createElement('div');
      title.className = 'section-title';
      title.textContent = sectionTitle;
      section.appendChild(title);

      if (data.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = 'No inputs generated yet.';
        section.appendChild(empty);
      } else {
        const table = document.createElement('table');
        table.className = 'history-table';

        const thead = document.createElement('thead');
        thead.innerHTML = `<tr><th>ID</th><th>Created At</th><th>Input Summary</th></tr>`;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        data.forEach(entry => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${entry.id}</td><td>${entry.created_at}</td><td>${entry.input}</td><td><button class="delete-btn">Delete</button></td>`;

          row.querySelector('.delete-btn').addEventListener('click', async ()=> {
            const response = await fetch(`/Web2025/Inpot/config/delete.php`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                id: entry.id,
                type: sectionTitle.toLowerCase().split(' ')[0]
              })
            });
            
            if(response.ok){
              alert('Entry deleted successfully');
            } else {
              alert('Failed to delete entry');
            }
          });

          tbody.appendChild(row);
        });

        

        table.appendChild(tbody);
        section.appendChild(table);
      }

      return section;
    }

    function renderHistory(data) {
      const container = document.getElementById('history-container');
      container.innerHTML = '';
      container.appendChild(createTable('Number Inputs', data.number));
      container.appendChild(createTable('String Inputs', data.string));
      container.appendChild(createTable('Vector Inputs', data.vector));
      container.appendChild(createTable('Matrix Inputs', data.matrix));
      container.appendChild(createTable('Graph Inputs', data.graph));
      container.appendChild(createTable('Tree Inputs', data.tree));
    }

    async function loadHistory() {
      try {
        const response = await fetch('/Web2025/Inpot/config/history.php');
        if (!response.ok) throw new Error('Failed to fetch history');
        const historyData = await response.json();
        renderHistory(historyData);
      } catch (error) {
        const container = document.getElementById('history-container');
        container.innerHTML = `<div class="error">Error loading history: ${error.message}</div>`;
      }
    }

    loadHistory();

  
  function createStatsTable(stats) {
    const section = document.createElement('div');
    section.className = 'section';

    const title = document.createElement('div');
    title.className = 'section-title';
    title.textContent = 'User Statistics';
    section.appendChild(title);

    const table = document.createElement('table');
    table.className = 'history-table';

    const tbody = document.createElement('tbody');

    const rows = [
      ['Total Generations', stats.total_generations],
      ['Number Inputs Count', stats.counts.number],
      ['String Inputs Count', stats.counts.string],
      ['Vector Inputs Count', stats.counts.vector],
      ['Matrix Inputs Count', stats.counts.matrix],
      ['First Generation Date', stats.first_generation],
      ['Last Generation Date', stats.last_generation],
      ['Avg Number Count', stats.averages.number_count],
      ['Min Number Count', stats.min_max.number_count.min],
      ['Max Number Count', stats.min_max.number_count.max],
      ['Avg String Count', stats.averages.string_count],
      ['Avg Vector Length', stats.averages.vector_length],
      ['Avg Matrix Size (rows × cols)', `${stats.averages.matrix_rows} × ${stats.averages.matrix_cols}`],
      ['Unique Input Combinations', stats.diversity.unique_combinations],
      ['Used `unique_numbers = true`', stats.diversity.unique_numbers_true],
      ['Used `vector_palindrome = true`', stats.diversity.vector_palindrome_true],
    ];

    rows.forEach(([label, value]) => {
      const row = document.createElement('tr');
      row.innerHTML = `<td><strong>${label}</strong></td><td>${value}</td>`;
      tbody.appendChild(row);
    });

    table.appendChild(tbody);
    section.appendChild(table);
    return section;
  }

  async function loadHistory() {
    try {
      const response = await fetch('/Web2025/Inpot/config/history.php');
      if (!response.ok) throw new Error('Failed to fetch history');
      const historyData = await response.json();
      renderHistory(historyData);

      const statsResponse = await fetch('/Web2025/Inpot/config/user_stats.php');
      if (!statsResponse.ok) throw new Error('Failed to fetch stats');
      const statsData = await statsResponse.json();
      document.getElementById('history-container').appendChild(createStatsTable(statsData));
    } catch (error) {
      const container = document.getElementById('history-container');
      container.innerHTML += `<div class="error">Error loading stats: ${error.message}</div>`;
    }
  }

  </script>
</body>
</html>
